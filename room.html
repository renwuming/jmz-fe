<!doctype html>
<html class="no-js">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>房间 | 截码战</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <link rel="icon" type="image/png" href="assets/i/favicon.png">
  <link rel="apple-touch-icon-precomposed" href="assets/i/app-icon72x72@2x.png">
  <meta name="apple-mobile-web-app-title" content="Amaze UI" />
  <link rel="stylesheet" href="assets/css/amazeui.min.css" />
  <link rel="stylesheet" href="assets/css/admin.css">
  <link rel="stylesheet" href="assets/css/app.css">
  <style>
    .am-btn {
      margin-bottom: 14px;
    }
  </style>
</head>

<body>
  <!--[if lte IE 9]>
<p class="browsehappy">你正在使用<strong>过时</strong>的浏览器，Amaze UI 暂不支持。 请 <a href="http://browsehappy.com/" target="_blank">升级浏览器</a>
  以获得更好的体验！</p>
<![endif]-->

  <header class="am-topbar am-topbar-inverse admin-header">
    <div class="am-topbar-brand">
      <strong>截码战</strong>&nbsp;<small>房间</small><a href='./rule' class='rule-tip' target='_blank'>| 查看规则</a>
    </div>

  </header>

  <div class="am-cf admin-main">

    <!-- content start -->
    <div class="admin-content">
      <div class="admin-content-body">
        <div class="am-g">
          <div class="am-u-sm-12">
            <form class="am-form">
              <table class="am-table am-table-striped am-table-hover table-main">
                <thead>
                  <tr>
                    <th class="table-check">
                      <!-- <input type="checkbox" /> -->
                    </th>
                    <th class="table-id"></th>
                    <th class="table-title">玩家</th>
                  </tr>
                </thead>
                <tbody id='tbody'>
                </tbody>
              </table>
            </form>
          </div>

          <div class="am-cf" style='text-align: center;'>
            <input name="" value="开始游戏" class="am-btn am-btn-primary am-btn-sm" id='submit' style='display:none;'>
          </div>
          <div class="am-cf" style='text-align: center;'>
            <input name="" value="加入房间" class="am-btn am-btn-primary am-btn-sm" id='join' style='display:none;'>
          </div>
          <div class="am-cf" style='text-align: center;'>
            <input name="" value="旁观游戏" class="am-btn am-btn-primary am-btn-sm" id='observe' style='display:none;'>
          </div>
          <div class="am-cf" style='text-align: center;'>
            <input name="" value="退出房间" class="am-btn am-btn-sm am-btn-danger" id='quit'>
          </div>
        </div>
      </div>

    </div>
    <!-- content end -->
  </div>


  <!--[if lt IE 9]>
<script src="http://libs.baidu.com/jquery/1.11.1/jquery.min.js"></script>
<script src="http://cdn.staticfile.org/modernizr/2.8.3/modernizr.js"></script>
<script src="assets/js/amazeui.ie8polyfill.min.js"></script>
<![endif]-->

  <!--[if (gte IE 9)|!(IE)]><!-->
  <!--<![endif]-->
  <script src='./assets/js/config.js'></script>
  <script src='./assets/js/zepto.js'></script>
  <script>
    var submit = document.querySelector('#submit')
    var join = document.querySelector('#join')
    var quit = document.querySelector('#quit')
    var observe = document.querySelector('#observe')
    var id = getQuery('id') // 获取roomID
    var gameID = null

    getRoomData() // 获取房间数据


    join.addEventListener('click', function () {
      joinRoom() // 加入房间
    })

    quit.addEventListener('click', function () {
      $.ajax({
        url: HOST + '/rooms/' + id + '/quit',
        contentType: "application/json",
        type: "POST",
        crossDomain: true,
        xhrFields: {
          withCredentials: true
        },
        dataType: 'json',
        success: function (res) {
          if ((res || {}).code === 408) {
            gotoLogin()
          }
          window.location = './index'
        },
      })
    })


    function joinRoom() {
      $.ajax({
        url: HOST + '/rooms/' + id,
        contentType: "application/json",
        type: "POST",
        crossDomain: true,
        xhrFields: {
          withCredentials: true
        },
        dataType: 'json',
        success: function (res) {
          if ((res || {}).code === 408) {
            gotoLogin()
          }
          join.style.display = 'none'
          alert('加入房间成功！')
        },
      })
    }

    function getRoomData() {
      $.ajax({
        url: HOST + '/rooms/' + id,
        type: "GET",
        crossDomain: true,
        xhrFields: {
          withCredentials: true
        },
        success: function (res) {
          if ((res || {}).code === 408) {
            gotoLogin()
          } else if (res.userList) {
            var list = res.userList.map((user, index) => {
              let html = `
              <tr>
                <td></td>
                <td>${index + 1}</td>
                <td><a href="#">${user.nick}</a></td>
              </tr>`
              return html
            })
            document.querySelector('#tbody').innerHTML = list.join('')
            // 若为房主，则可以开始游戏
            if (res.ownRoom) {
              submit.style.display = 'inline-block'
            } else if (!res.inRoom) {
              join.style.display = 'inline-block'
            }
            if (res.activeGame && res.inGame) {
              window.location = './web-mobile/index?id=' + res.activeGame
            }
            if (res.activeGame && res.inRoom && !res.inGame) {
              gameID = res.activeGame
              observe.style.display = 'inline-block'
            }
          }
        },
      })

      setTimeout(getRoomData, 3000)
    }


    observe.addEventListener('click', function () {
      window.location = './web-mobile/index?id=' + gameID
    })

    submit.addEventListener('click', function () {
      $.ajax({
        url: HOST + '/rooms/' + id + '/start',
        contentType: "application/json",
        type: "POST",
        crossDomain: true,
        xhrFields: {
          withCredentials: true
        },
        dataType: 'json',
        success: function (res) {
          if (res.code === 408) {
            gotoLogin()
          } else if (res.code === 501) {
            alert('你不是房主 or 人数小于4！')
          } else if (res.id) {
            window.location = './web-mobile/index?id=' + res.id
            // window.location = 'http://localhost:7456?id=' + res.id
          }
        },
      })
    })
  </script>
</body>

</html>